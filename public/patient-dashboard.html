<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Patient Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --accent: #2575fc;
  --accent2: #6a11cb;
  --bg: #eef3ff;
  --card: #ffffff;
  --muted: #6b7280;
  --sidebar: #1e2a47;
}

/* Smooth transitions */
*{ box-sizing:border-box; transition: all 0.25s ease; }
body{ margin:0; font-family:"Poppins",sans-serif; color:#111827;
       background: linear-gradient(-45deg, #e3ebff, #d4e2ff, #eaf1ff, #cddaff);
       background-size: 400% 400%; animation: gradientMove 15s infinite ease alternate; }
@keyframes gradientMove{ 0%{background-position:0% 50%;} 100%{background-position:100% 50%;} }

.wrapper{ display:flex; min-height:100vh; animation: fadeIn 0.8s ease; }
@keyframes fadeIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

/* Sidebar */
.sidebar{
  width:240px; background:var(--sidebar); color:white; padding:22px; position:fixed;
  top:0; left:0; bottom:0; display:flex; flex-direction:column; gap:18px;
  box-shadow:4px 0 18px rgba(0,0,0,0.12);
  transform: translateX(-50px); opacity:0; animation: sidebarSlide 0.9s ease forwards;
}
@keyframes sidebarSlide{ from{ opacity:0; transform:translateX(-50px);} to{ opacity:1; transform:translateX(0);} }

.brand{ font-size:22px; font-weight:600; text-align:center; margin-bottom:8px; letter-spacing:0.5px; }
.profile{ display:flex; flex-direction:column; align-items:center; gap:8px; padding:12px;
          border-radius:10px; background:rgba(255,255,255,0.05); animation: popIn 0.8s ease forwards; }
@keyframes popIn{ from{transform:scale(0.95); opacity:0;} to{transform:scale(1); opacity:1;} }

.profile img{ width:72px; height:72px; border-radius:50%; object-fit:cover;
              border:2px solid rgba(255,255,255,0.12); transition: transform .3s; }
.profile img:hover{ transform: scale(1.07); }

/* Nav */
.nav{ display:flex; flex-direction:column; gap:8px; margin-top:6px; }
.nav a{ color:white; text-decoration:none; padding:10px; border-radius:8px;
        display:flex; align-items:center; gap:8px; font-weight:500; background:transparent; transition:0.3s; }
.nav a:hover{ background:rgba(255,255,255,0.1); transform:translateX(8px); }

.logoutBtn{ margin-top:auto; background:#ff4b5c; border:none; color:white;
            padding:10px; border-radius:8px; cursor:pointer; font-weight:600; }
.logoutBtn:hover{ filter:brightness(.92); transform:scale(1.03); }

/* Main Content */
.content{ margin-left:260px; padding:28px; flex:1; }
.welcome{ background:var(--card); padding:22px; border-radius:14px;
          box-shadow:0 8px 20px rgba(2,6,23,0.08); display:flex; align-items:center;
          justify-content:space-between; gap:16px; animation: fadeDown 0.8s ease; }
@keyframes fadeDown{ from{opacity:0; transform:translateY(-15px);} to{opacity:1; transform:translateY(0);} }

/* Filters */
.filters{ display:flex; gap:12px; margin-top:18px; flex-wrap:wrap; animation: fadeIn 1s ease; }
.filters input, .filters select{ padding:10px 12px; border-radius:10px; border:1px solid #d1d5db;
                                 background:white; font-size:14px; min-width:160px; outline:none; }
.filters input:focus, .filters select:focus{ border-color:var(--accent); box-shadow:0 0 8px rgba(37,117,252,0.4); }

/* Doctor Cards */
.grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; margin-top:20px; animation: fadeIn 1.2s ease; }
.card{ background:var(--card); padding:18px; border-radius:12px; box-shadow:0 8px 18px rgba(2,6,23,0.06);
       text-align:center; transition: transform .25s, box-shadow .25s; }
.card:hover{ transform:translateY(-6px) scale(1.02); box-shadow:0 10px 24px rgba(2,6,23,0.12); }
.card img{ width:84px; height:84px; border-radius:50%; object-fit:cover; border:3px solid var(--accent); transition: transform .3s; }
.card img:hover{ transform: scale(1.08) rotate(2deg); }
.card button{ margin-top:12px; background:var(--accent); color:white; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600; transition:0.3s; }
.card button:hover{ background:#1b5ed1; transform:scale(1.05); }

.center{ display:flex; align-items:center; justify-content:center; padding:30px; color:var(--muted); }

/* Modal */
.modal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
.modal-content{ background:white; padding:20px; border-radius:10px; max-width:400px; width:90%; position:relative; }
.modal-content h3{ margin-top:0; }
.close-modal{ position:absolute; top:10px; right:10px; cursor:pointer; font-weight:bold; }

/* Mobile */
@media (max-width:800px){ .sidebar{display:none;} .content{margin-left:0; padding:16px;} }

</style>
</head>
<body>

<div class="wrapper">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">üè• HealthCare+</div>
    <div class="profile">
      <img id="userPhoto" src="https://cdn-icons-png.flaticon.com/512/147/147144.png" alt="user">
      <h4 id="userName">Loading...</h4>
      <p id="userEmail">‚Äî</p>
    </div>

    <nav class="nav">
      <a href="/patient.html">Dashboard</a>
      <a href="/book.html">üìÖ Book Appointment</a>
      <a href="/history.html">üìù My Appointments</a>
      <a href="/profile-dashboard.html">üë§ My Profile</a>
    </nav>

    <button class="logoutBtn" id="logoutBtn">üö™ Logout</button>
  </aside>

  <!-- Main Content -->
  <main class="content">
    <div class="welcome">
      <div class="left">
        <h2 id="welcomeText">Welcome, Patient üëã</h2>
        <p id="welcomeSub">Your dashboard for appointments & health services.</p>
      </div>
      <div class="right note" id="statusNote"></div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <input id="searchName" type="text" placeholder="Search doctor by name">
      <select id="filterSpecialization"><option value="">All Specializations</option></select>
      <select id="filterSlot">
        <option value="">Any Slot</option>
        <option value="morning">Morning</option>
        <option value="afternoon">Afternoon</option>
        <option value="evening">Evening</option>
      </select>
      <input id="searchSymptom" type="text" placeholder="Symptom (e.g., fever)">
    </div>

    <!-- Doctor Grid -->
    <h3 style="margin-top:18px">Available Doctors</h3>
    <div id="doctorGrid" class="grid"></div>
    <div id="emptyMsg" class="center" style="display:none">No doctors found.</div>
  </main>
</div>

<!-- Doctor Details Modal -->
<div class="modal" id="doctorModal">
  <div class="modal-content">
    <span class="close-modal" id="closeModal">√ó</span>
    <img id="modalPhoto" src="" style="width:100px;height:100px;border-radius:50%;object-fit:cover;margin-bottom:12px;">
    <h3 id="modalName"></h3>
    <p><strong>Specialization:</strong> <span id="modalSpec"></span></p>
    <p><strong>Available Slots:</strong> <span id="modalSlots"></span></p>
    <p><strong>Symptoms:</strong> <span id="modalSymptoms"></span></p>
  </div>
</div>

<script>
const doctorGrid = document.getElementById('doctorGrid');
const emptyMsg = document.getElementById('emptyMsg');
let doctorsData = [];

// Load user session
async function loadUser(){
  try{
    const res = await fetch('/api/auth/me', { credentials: 'include' });
    if (!res.ok) { window.location.href = '/login.html'; return; }
    const { user } = await res.json();
    if(user){
      document.getElementById('userName').innerText = user.name || 'Patient';
      document.getElementById('userEmail').innerText = user.email || '';
      document.getElementById('welcomeText').innerText = `Welcome, ${user.name || 'Patient'} üëã`;
      if(user.photo) document.getElementById('userPhoto').src=user.photo;
    }
  }catch(err){ console.error(err); window.location.href='/login.html'; }
}

// Load doctors
async function loadDoctors(){
  try{
    const res = await fetch('/api/appointments/doctors', { credentials: 'include' });
    if(!res.ok){ document.getElementById('statusNote').innerText='Error loading doctors.'; return; }
    const js = await res.json();
    doctorsData = js.doctors || [];
    populateSpecializations();
    renderDoctors(doctorsData);
  }catch(err){ console.error(err); document.getElementById('statusNote').innerText='Failed to load doctors.'; }
}

// Populate specialization select
function populateSpecializations(){
  const select=document.getElementById('filterSpecialization');
  select.innerHTML='<option value="">All Specializations</option>';
  const specs=doctorsData.map(d=>d.specialization).filter(Boolean).map(s=>s.trim())
              .filter((v,i,a)=> a.indexOf(v)===i);
  specs.forEach(s=>{
    const o=document.createElement('option'); o.value=s; o.innerText=s; select.appendChild(o);
  });
}

// Render doctors
function renderDoctors(list){
  doctorGrid.innerHTML='';
  if(!Array.isArray(list) || list.length===0){ emptyMsg.style.display='block'; return; }
  emptyMsg.style.display='none';

  list.forEach(d=>{
    const photo=d.photo || 'https://cdn-icons-png.flaticon.com/512/3774/3774299.png';
    const specialization=d.specialization || 'General';
    const docCard=document.createElement('div'); docCard.className='card';
    docCard.innerHTML=`
      <img src="${photo}" alt="${escapeHtml(d.name)}">
      <h3>${escapeHtml(d.name)}</h3>
      <p>Specialization: ${escapeHtml(specialization)}</p>
      <button class="bookBtn" data-id="${d._id}" data-name="${escapeHtml(d.name)}">Book Appointment</button>
      <button class="viewBtn" data-id="${d._id}">View Details</button>
    `;
    // Book appointment
    docCard.querySelector('.bookBtn').addEventListener('click', e=>{
      const id=e.currentTarget.dataset.id;
      const name=e.currentTarget.dataset.name;
      localStorage.setItem('book_doctorId',id);
      localStorage.setItem('book_doctorName',name);
      window.location.href='/book.html';
    });
    // View details
    docCard.querySelector('.viewBtn').addEventListener('click', e=>{
      const doctor=doctorsData.find(doc=>doc._id===e.currentTarget.dataset.id);
      if(!doctor) return;
      document.getElementById('modalPhoto').src=doctor.photo||photo;
      document.getElementById('modalName').innerText=doctor.name;
      document.getElementById('modalSpec').innerText=doctor.specialization||'General';
      document.getElementById('modalSlots').innerText=(Array.isArray(doctor.availableSlots)?doctor.availableSlots.join(', '):doctor.availableSlots)||'‚Äî';
      document.getElementById('modalSymptoms').innerText=(Array.isArray(doctor.symptoms)?doctor.symptoms.join(', '):doctor.symptoms)||'‚Äî';
      document.getElementById('doctorModal').style.display='flex';
    });
    doctorGrid.appendChild(docCard);
  });
}

// Escape HTML helper
function escapeHtml(text){ if(text==null) return ''; return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

// Logout
document.getElementById('logoutBtn').addEventListener('click', async ()=>{
  try{ await fetch('/api/auth/logout',{method:'POST',credentials:'include'}); }catch(e){}
  window.location.href='/';
});

// Filter doctors
function normalizeSymptomsField(field){
  if(!field) return [];
  if(Array.isArray(field)) return field.map(s=>String(s).toLowerCase().trim()).filter(Boolean);
  if(typeof field==='string') return field.split(/[,;|]/).map(s=>s.toLowerCase().trim()).filter(Boolean);
  return [String(field).toLowerCase().trim()];
}
function filterDoctors(){
  const name=document.getElementById('searchName').value.trim().toLowerCase();
  const spec=document.getElementById('filterSpecialization').value;
  const slot=document.getElementById('filterSlot').value;
  const symptomInput=document.getElementById('searchSymptom').value.trim().toLowerCase();

  const filtered=doctorsData.filter(d=>{
    if(name && !(d.name||'').toLowerCase().includes(name)) return false;
    if(spec && (d.specialization||'')!==spec) return false;
    if(slot){
      const slots=Array.isArray(d.availableSlots)?d.availableSlots:((d.availableSlots||'').toString().split(/[,;|]/).map(s=>s.trim()));
      if(!slots.some(s=>s.toLowerCase()===slot)) return false;
    }
    if(symptomInput){
      const docSymptoms=normalizeSymptomsField(d.symptoms);
      if(!docSymptoms.some(s=>s.includes(symptomInput))) return false;
    }
    return true;
  });
  renderDoctors(filtered);
}

// Attach filter listeners
['searchName','filterSpecialization','filterSlot','searchSymptom'].forEach(id=>{
  const el=document.getElementById(id);
  if(!el) return;
  el.addEventListener('input', debounce(filterDoctors,180));
});

// Debounce
function debounce(fn, wait){ let t; return function(...args){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args),wait); }; }

// Modal close
document.getElementById('closeModal').addEventListener('click', ()=>{ document.getElementById('doctorModal').style.display='none'; });
document.getElementById('doctorModal').addEventListener('click', e=>{ if(e.target.id==='doctorModal') e.currentTarget.style.display='none'; });

// Initialize
(async function init(){ await loadUser(); await loadDoctors(); })();
</script>
</body>
</html>
